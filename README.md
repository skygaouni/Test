# 微算機原理與應用 期末專題報告

## 題目

PicHome 智慧家庭

## 組員

張育銓、柯兆陽、周柏儒、曾立綸

## 專題動機

現代人越來越重視居住環境的方便性，各種智慧家庭概念裝置充斥我們的生活中。這次專題的製作，我們希望以「智慧裝置控制」以及「環境監測數據即時傳輸」為核心概念，打造一個整合各種感測器與藍牙傳輸技術的智慧家庭系統。希望不僅能滿足日常生活中的需求，還能幫助我們深入學習微算機技術的整合應用，並探索如何將科技融入日常生活，創造更美好的居住體驗。

## 系統功能與原理說明

### 環境監測

系統通過溫濕度感測器模組即時監測環境數據，並將數據傳輸至手機 APP 顯示。

- 功能說明：
	1. 使用 DHT11 模組測量環境的溫度與濕度。
	2. 資料透過 UART 傳輸至手機 APP，並顯示於使用者介面。
	3. 以 AI 模型預測當前溫濕度的人體舒適指數，提供即時的舒適性建議。
- 運作原理：
	1. DHT11 依據內部濕敏元件與熱敏電阻的變化計算出溫濕度數值。
	2. 模組生成數據，包含溫濕度數據與檢查碼。
	3. 擷取數據整數部分，透過 UART 接口傳至 PIC18F4520，再傳至手機 APP 顯示。
- 程式碼段落：
	```c
	char DHT11_ReadData() {
		char i, data = 0;  
		for (i = 0; i < 8; i++)
		{
			while (!(Data_In & 1));
			__delay_us(30);         
			if (Data_In & 1)
				data = ((data << 1) | 1); 
			else
				data = (data << 1);
			while (Data_In & 1);
		}
		return data;
	}
	```
	```c
	void ReadData(char *t, char *h) {
		char RH_Decimal, RH_Integral, T_Decimal, T_Integral, Checksum;
		RH_Integral = DHT11_ReadData();
		RH_Decimal = DHT11_ReadData();
		T_Integral = DHT11_ReadData();
		T_Decimal = DHT11_ReadData();
		Checksum = DHT11_ReadData();
		*t = T_Integral;
		*h = RH_Integral;
	}
	```

### 感測器控制

根據環境監測數據與使用者選擇的控制模式（手動模式或自動模式），進行智慧化的設備操作控制。

- 功能說明：
	1. 在手動模式中，使用者可透過 APP 界面直接控制窗簾、電燈與電扇的開關。
	2. 在自動模式中，系統根據感測數據自動調整設備狀態，例如根據光線強度自動開關窗簾與電燈、根據溫濕度數據自動控制電扇。
- 運作原理：
	1. 光敏電阻值反映環境光線強弱，經由 ADC 模組轉換為數字訊號。
	2. 溫濕度影響設備控制，透過當前實時溫度值，在自動模式下自動啟動或關閉電扇模組。

### 窗簾控制

使用 SG90 伺服馬達驅動窗簾開合，並在自動模式下連接當前環境數據自動控制。

- 功能說明：
	1. 在手動模式下，使用者可透過手機 APP 控制上升、下降或停止窗簾。
	2. 在自動模式下，系統根據光線強度自動調整窗簾。
- 運作原理：
	1. SG90 接收 PWM 信號，調整伺服馬達的角度。
	2. 通過拉動繩索驅動窗簾開關。
	3. 控制指令由 APP 發送，通過 UART 傳至開發板。
- 程式碼段落：
	```c
	if(data_in == 'u') // 上升窗簾
	{
		ClearBuffer();
		CCPR1L = angle_open >> 2;
		CCP1CONbits.DC1B = (angle_open & 0b11);
	}
	else if(data_in == 'd') // 降下窗簾
	{
		ClearBuffer();
		CCPR1L = angle_close >> 2;
		CCP1CONbits.DC1B = (angle_close & 0b11);
	}
	else if(data_in == 's') // 停止窗簾
	{
		ClearBuffer();
		CCPR1L = angle_stop >> 2;
		CCP1CONbits.DC1B = (angle_stop & 0b11);
	}
	```
	```c
	if (mode == 1) { // 自動模式
		int light_value = ADC_Read();
		if (light_value < 100) {
			CCPR1L = angle_open >> 2;
			CCP1CONbits.DC1B = (angle_open & 0b11);
		} else if (light_value > 200) {
			CCPR1L = angle_close >> 2;
			CCP1CONbits.DC1B = (angle_close & 0b11);
		}
	}
	```

### 風扇模組控制

透過伺服馬達與直流馬達的結合，可以使風扇模組的進行控制與切換的操作，並使用繼電器進行風扇的啟停切換。

- 功能說明：
	1. 在手動模式下，使用者可透過手機 APP 控制風扇的啟動、停止及擺動模式。
	2. 在自動模式下，根據溫度數據自動調整風扇的啟停，當溫度超過設定值時，啟動風扇進行降溫。
- 運作原理：
	1. 伺服馬達控制風扇的擺動角度（0° 至 180°），提供多種角度送風。
	2. 直流馬達驅動風扇葉片運轉，透過繼電器控制電源的通斷。
	3. 系統根據溫度值自動決定風扇的啟動與停止，並在自動模式下執行風扇擺動。

## 系統使用環境及對象

### 使用環境

我們設計的 HomePic 智慧家庭系統主要考量的使用環境為現代居住空間，希望透過整合感測器、應用程式與自動化控制技術，提升使用者的生活便利性。
1. 家庭住宅
針對居家生活需求，例如臥室、客廳和廚房，提供智慧且易於使用的環境監控與控制功能。
2. 辦公空間
這個 HomePic 智慧家庭系統亦可用於中小型辦公室，藉由調節燈光與室內設備，提升辦公之舒適性。
3. 公共場所
除了私人場所外，這個系統亦可延伸至公共場所，透過光線與溫濕度感測器，連接行動裝置自動調節設備，創造更令人舒適的環境條件。

### 使用對象

1. 注重生活品質的家庭用戶
2. 智慧家庭設備愛好者
3. 企業管理人員
4. 學術教育場所

## 系統開發工具、材料及技術

### 系統開發工具

- MPLAB X IDE v5.20
使用此 IDE 進行 C 語言程式開發與編譯，並連接至 PIC18F4520 開發板
- MIT App Inventor 2
用以開發手機 APP，進行 UI 設計以及與開發板中的藍芽模組進行數據傳輸

### 使用之材料

- PIC18F4520
整個系統的核心處理控制器，負責數據接收、處理及控制各項模組設備
- HC-05 藍芽模組
用於手機 APP 與系統主開發板之間的數據傳輸
- DHT11 溫濕度感測模組
感測環境的即時溫濕度數據，作為自動化控制的依據，並實時顯示至手機 APP
- 光敏電阻模組
測量環境光線強度，控制窗簾與電燈在自動模式下的開關狀態
- 紅外線避障感測器
用於窗簾位置檢測，確保伺服馬達運行的精準性
- SG90 伺服馬達
用於控制窗簾，透過拉動繩索進行開關
- LED 燈泡
安裝於紙箱上方，作為環境光源的模擬設備，接收系統訊號進行亮暗切換
- 風扇模組
由直流馬達、180 度伺服馬達和繼電器模組組成，直流馬達驅動風扇進行空氣流通，伺服馬達負責調整送風的方向，而繼電器則通過控制電路的通斷來完成直流馬達的啟停。

### 進階技術使用 - AI 預測人體舒適指數

1. 我們在網路上找尋了「溫度、濕度、人體舒適度」之資料集，並將其使用隨機森林模型進行訓練，輸入當前溫度、濕度值後，可以預測當前環境的人體舒適度（範圍為 1~10）。
	```python
	import pandas as pd
	from sklearn.model_selection import train_test_split
	from sklearn.ensemble import RandomForestRegressor
	dataset_path = "dataset.csv"
	data = pd.read_csv(dataset_path)
	X = data[["Temperature", "Humidity"]]
	y = data["Comfort Index"]
	X_train, X_test, y_train, y_test = train_test_split(
		X, y, test_size=0.2, random_state=42)
	model = RandomForestRegressor(n_estimators=100, random_state=42)
	model.fit(X_train, y_train)
	```
2. 之後將溫度 0~40 度的整數值與濕度 0~100% 的整數值放入模型進行預測，將所有結果存至 CSV 檔案中。
3. 將 CSV 檔案導入至手機 APP 中，當接收到實時溫溼度數據後，進行查表並將預測人體舒適度顯示供使用者參考。

## 周邊接口與單元項目細節

### UART
- 用途：
負責 PIC18F4520 與 HC-05 藍芽模組的通訊，負責接收手機 APP 傳送的指令並傳輸感測器數據至手機 APP。
- 系統設計：
	1. 初始化程式碼： 在 `setting.c` 中呼叫 `UART_Initialize()`，初始化 UART 接口，設置 Baud rate 和控制位元。
	2. 數據傳輸與接收： 在 `main.c` 中，通過 `UART_Write_Text` 傳送數據至手機 APP，並且分析接收到的指令，執行接下來的程式。

#### 手機 APP 傳輸至 PIC18F4520 之代碼意義

| 代碼 | 項目意義     |
| ---- | -------- |
| `t` | 要求溫度傳輸 |
| `h` | 要求濕度傳輸 |
| `m` | 改為手動模式 |
| `a` | 改為自動模式 |
| `1` | 開啟 LED 電燈（手動模式限定） |
| `0` | 關閉 LED 電燈（手動模式限定） |
| `u` | 控制窗簾上升（手動模式限定） |
| `d` | 控制窗簾下降（手動模式限定） |
| `s` | 控制窗簾停止（手動模式限定） |
| `f` | 控制風扇開啟（手動模式限定） |
| `g` | 控制風扇關閉（手動模式限定） |
| `y` | 控制風扇循環開啟（手動模式限定） |
| `z` | 控制風扇循環關閉（手動模式限定） |

### ADC
- 用途：
讀取光敏電阻的數據，進行光線強度的測量，並將結果用於自動化控制。
- 系統設計：
	1. 初始化程式碼： 在 `adc.c` 中，設置 `AN0` 為類比輸入，設定 ADC 模組的參考電壓和轉換時間。
	2. 數據讀取： 使用 `ADC_Read()` 函式進行訊號之間的轉換。

### PWM
- 用途：
使用 PWM 控制 SG90 伺服馬達的位置，進行窗簾的開關操作。
- 系統設計：
	1. 初始化程式碼： 在 `ccp1.c` 中設置 CCP1 模組為 PWM 模式，並設置 Timer2 為 PWM 時鐘。
	2. 控制伺服馬達： 通過改變 `CCPR1L` 與 `CCP1CONbits.DC1B` 改變伺服馬達的角度，使用 CCPR1L 和 DC1B 設定 PWM 寬度。

## 遇到的困難

### 藍芽通訊問題

在開發初期，我們發現藍芽模組在與手機 APP 配對的過程中常常發生連線錯誤，導致接收數據與傳輸指令出現問題。為解決這些問題，我們更改了手機 APP 程式的編寫方式，儘管我們對手機應用程式的開發並不熟悉，但我們仍積極學習相關技術，包括藍芽通訊與資料處理的邏輯。最終在不斷測試下，終於找到一個穩定性較佳的解決方案。我們通過重新設定 HC-05 模組的參數，減少外部干擾對藍芽模組的影響，使整個數據傳輸機制更加可靠。

### AI 模型過大無法使用

原先我們想將預測人體舒適度之模型直接放入 PIC18F4520 中，但其模型檔案過大，若將其先轉為 C 語言後轉入，開發板提供之記憶體仍不夠使用，導致系統當機。後來考量到我們顯示在手機 APP 的溫濕度數據只有整數部分，也就是所有的溫溼度數據可能是有限的，因此我們想到可以使用查表的方式，先將所有的可能進行預測後，存入 CSV 檔案中，再由手機 APP 進行查表即時顯示。

### 風扇模組設計問題

原本計劃直接使用 RA2 作為馬達的訊號來源，當 RA2 輸出高電位時，風扇啟動；輸出低電位時，風扇停止。然而，當直流馬達接上RA2 後，我發現 PIC18F4520 會因電壓不穩而導致 target halted 問題。為了解決這個問題，我改用繼電器來接上外部電源（另一條 5V 的 TTL 線供電）。這樣的設計不僅避免了馬達與其他 I/O 腳位爭搶電流，還能透過 RA2 輕鬆控制馬達的開關。

## Demo 影片

https://youtube.com/shorts/Y5DXfb-moSc
